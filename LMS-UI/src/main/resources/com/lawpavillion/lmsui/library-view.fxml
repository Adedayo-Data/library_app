<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.shape.Line?>
<?import org.kordamp.ikonli.javafx.FontIcon?>

<StackPane xmlns="http://javafx.com/javafx"
           xmlns:fx="http://javafx.com/fxml"
           fx:controller="com.lawpavillion.lmsui.controller.LibraryController"
           stylesheets="@styles.css"
           styleClass="root-stack">

    <!-- Layer 1: Main Dashboard -->
    <HBox styleClass="main-container">
        <!-- Sidebar -->
        <VBox styleClass="sidebar" spacing="16" alignment="CENTER" minWidth="80" maxWidth="80">
            <padding>
                <Insets top="24" bottom="24"/>
            </padding>
            
            <!-- App Icon -->
            <StackPane styleClass="app-icon-container">
               <javafx.scene.image.ImageView fitHeight="40" fitWidth="40" preserveRatio="true">
                   <image>
                       <javafx.scene.image.Image url="@images/app_icon.png"/>
                   </image>
               </javafx.scene.image.ImageView>
            </StackPane>
            
            <Region VBox.vgrow="SOMETIMES"/>
            
            <!-- Nav Icons -->
            <Button fx:id="searchButton" styleClass="sidebar-icon-button" onAction="#handleSearch">
                <graphic>
                    <FontIcon iconLiteral="mdi2m-magnify" iconSize="20" iconColor="white"/>
                </graphic>
                <tooltip>
                    <Tooltip text="Search Library"/>
                </tooltip>
            </Button>

            <Button fx:id="refreshButton" styleClass="sidebar-icon-button" onAction="#handleRefresh">
                <graphic>
                    <FontIcon iconLiteral="mdi2r-refresh" iconSize="20" iconColor="white"/>
                </graphic>
                <tooltip>
                    <Tooltip text="Refresh"/>
                </tooltip>
            </Button>

            <Line startX="0" endX="24" stroke="rgba(255, 255, 255, 0.1)" strokeWidth="1">
                <VBox.margin>
                    <Insets top="8" bottom="8"/>
                </VBox.margin>
            </Line>

            <Button fx:id="addButton" styleClass="sidebar-icon-button" onAction="#handleAdd">
                <graphic>
                    <FontIcon iconLiteral="mdi2p-plus-circle" iconSize="20" iconColor="white"/>
                </graphic>
                <tooltip>
                    <Tooltip text="Add New Book"/>
                </tooltip>
            </Button>

            <Button fx:id="deleteSelectedButton" styleClass="sidebar-icon-button, sidebar-danger-button" 
                    onAction="#handleDeleteSelected" disable="true" visible="false" managed="false">
                <graphic>
                    <FontIcon iconLiteral="mdi2d-delete" iconSize="20" iconColor="#EF4444"/>
                </graphic>
                <tooltip>
                    <Tooltip text="Delete Selected"/>
                </tooltip>
            </Button>

            <Region VBox.vgrow="SOMETIMES"/>
            
            <!-- User Avatar -->
            <Label styleClass="user-avatar-container">
                 <padding>
                    <Insets top="8" right="8" bottom="8" left="8"/>
                 </padding>
                 <graphic>
                    <FontIcon iconLiteral="mdi2a-account-circle" iconSize="24" iconColor="#64748B"/>
                 </graphic>
                 <tooltip>
                    <Tooltip text="Admin User"/>
                 </tooltip>
            </Label>
        </VBox>

        <!-- Main Content Area -->
        <VBox HBox.hgrow="ALWAYS" spacing="0">
            <padding>
                <Insets top="20" right="30" bottom="20" left="30"/>
            </padding>

            <!-- Header Card -->
            <HBox styleClass="header-card" alignment="CENTER_LEFT" spacing="12">
                <VBox spacing="1">
                    <Label text="Law Pavillion" styleClass="page-title"/>
                    <Label fx:id="statusLabel" text="Ready" styleClass="page-subtitle"/>
                </VBox>
                
                <!-- Active Search Chip -->
                <HBox fx:id="activeSearchChip" styleClass="search-chip" spacing="8" visible="false" managed="false" alignment="CENTER_LEFT">
                    <Label fx:id="activeSearchLabel" text="Results for: 'Java'" styleClass="search-chip-label"/>
                    <Button styleClass="search-chip-close" onAction="#handleClearSearch">
                        <graphic>
                            <FontIcon iconLiteral="mdi2c-close-circle" iconSize="16"/>
                        </graphic>
                        <tooltip>
                            <Tooltip text="Clear Search"/>
                        </tooltip>
                    </Button>
                </HBox>
                
                <Region HBox.hgrow="ALWAYS"/>
                
                <HBox alignment="CENTER_RIGHT" spacing="10">
                    <Label fx:id="totalBooksLabel" text="Total Books: 0" styleClass="header-stat-chip"/>
                    <Label fx:id="pageLabel" text="Page 1 of 1" styleClass="header-stat-chip"/>
                </HBox>
            </HBox>

            <!-- Explicit Spacer for Separation -->
            <Region minHeight="22" maxHeight="22" VBox.vgrow="NEVER"/>

            <!-- Table Card Container -->
            <VBox styleClass="table-card" VBox.vgrow="ALWAYS">
                <TableView fx:id="bookTable" VBox.vgrow="ALWAYS" styleClass="dashboard-table">
                <columns>
                    <TableColumn fx:id="selectColumn" text="" prefWidth="50" sortable="false"/>
                    <TableColumn fx:id="titleColumn" text="Title" prefWidth="250"/>
                    <TableColumn fx:id="authorColumn" text="Author" prefWidth="200"/>
                    <TableColumn fx:id="isbnColumn" text="ISBN" prefWidth="150"/>
                    <TableColumn fx:id="publishedDateColumn" text="Published Date" prefWidth="150"/>
                </columns>
                <columnResizePolicy>
                    <TableView fx:constant="CONSTRAINED_RESIZE_POLICY"/>
                </columnResizePolicy>
                </TableView>

                <HBox styleClass="pagination-bar" spacing="6" alignment="CENTER">
                    <Button fx:id="firstPageButton" text="«" styleClass="pagination-number" onAction="#handleFirstPage"/>
                    <Button fx:id="prevPageButton" text="‹" styleClass="pagination-number" onAction="#handlePreviousPage"/>
                    <Label fx:id="pageNumberLabel" text="1" styleClass="pagination-current"/>
                    <Button fx:id="nextPageButton" text="›" styleClass="pagination-number" onAction="#handleNextPage"/>
                    <Button fx:id="lastPageButton" text="»" styleClass="pagination-number" onAction="#handleLastPage"/>
                </HBox>
            </VBox>
        </VBox>
    </HBox>

    <!-- Layer 2: Form Modal Overlay -->
    <StackPane fx:id="modalOverlay" visible="false" styleClass="modal-backdrop" alignment="CENTER">
        <VBox styleClass="modal-dialog" maxWidth="500" maxHeight="500" spacing="20">
            <padding>
                <Insets top="32" right="40" bottom="32" left="40"/>
            </padding>
            
            <Label fx:id="modalTitle" text="Add New Book" styleClass="modal-title"/>
            
            <VBox spacing="16">
                <VBox spacing="6">
                    <Label text="Title" styleClass="input-label"/>
                    <TextField fx:id="titleField" promptText="Enter book title"/>
                </VBox>
                
                <VBox spacing="6">
                    <Label text="Author" styleClass="input-label"/>
                    <TextField fx:id="authorField" promptText="Enter author name"/>
                </VBox>
                
                <HBox spacing="16">
                    <VBox spacing="6" HBox.hgrow="ALWAYS">
                        <Label text="ISBN" styleClass="input-label"/>
                        <TextField fx:id="isbnField" promptText="ISBN-13"/>
                    </VBox>
                    <VBox spacing="6" HBox.hgrow="ALWAYS">
                        <Label text="Published Date" styleClass="input-label"/>
                        <DatePicker fx:id="datePicker" promptText="Select date"/>
                    </VBox>
                </HBox>
            </VBox>
            
            <HBox spacing="12" alignment="CENTER_RIGHT" styleClass="modal-actions">
                <Button text="Cancel" styleClass="button-secondary" onAction="#handleCancelModal"/>
                <Button text="Save Book" styleClass="button-primary" onAction="#handleSaveBook"/>
            </HBox>
        </VBox>
    </StackPane>
    
    <!-- Layer 3: Delete Confirmation Modal -->
    <StackPane fx:id="deleteOverlay" visible="false" styleClass="modal-backdrop" alignment="CENTER">
         <VBox styleClass="modal-dialog" maxWidth="400" maxHeight="300" spacing="16" alignment="CENTER">
            <padding>
                <Insets top="32" right="32" bottom="32" left="32"/>
            </padding>
            <FontIcon iconLiteral="mdi2a-alert-circle" iconSize="48" iconColor="#EF4444"/>
            <Label text="Delete Book?" styleClass="modal-title"/>
            <Label text="Are you sure you want to delete this? This action cannot be undone." wrapText="true" textAlignment="CENTER" styleClass="modal-message"/>
            
            <HBox spacing="16" alignment="CENTER">
                <Button text="Cancel" styleClass="button-secondary" onAction="#handleCancelDelete"/>
                <Button text="Delete" styleClass="button-danger" onAction="#handleConfirmDelete"/>
            </HBox>
         </VBox>
    </StackPane>

    <!-- Layer 4: Search Modal Overlay -->
    <StackPane fx:id="searchOverlay" visible="false" styleClass="modal-backdrop" alignment="CENTER">
        <VBox styleClass="modal-dialog" maxWidth="500" maxHeight="200" spacing="20" alignment="CENTER_LEFT">
            <padding>
                <Insets top="24" right="32" bottom="24" left="32"/>
            </padding>
            
            <Label text="Search Library" styleClass="modal-title"/>
            
            <TextField fx:id="searchField" promptText="Search by title or author..." styleClass="text-input" prefWidth="400" onAction="#handlePerformSearch"/>
            
            <HBox spacing="12" alignment="CENTER_RIGHT">
                <Button text="Cancel" styleClass="button-secondary" onAction="#handleCancelSearch"/>
                <Button text="Search" styleClass="button-primary" onAction="#handlePerformSearch"/>
            </HBox>
        </VBox>
    </StackPane>


    <!-- Layer 5: Toast Notification -->
    <VBox fx:id="toastOverlay" alignment="BOTTOM_CENTER" visible="false" pickOnBounds="false">
        <padding>
            <Insets bottom="50"/>
        </padding>
        <StackPane styleClass="toast-bubble" maxWidth="400">
             <Label fx:id="toastLabel" text="Operation Successful" styleClass="toast-text" textFill="white"/>
        </StackPane>
    </VBox>

</StackPane>
